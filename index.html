<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="format-detection" content="telephone=no">
<title>Rapid Labs | Research Products</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap');
  :root {
    --navy-deep: #0b1528; --navy: #122042; --navy-mid: #1a2d5a; --navy-light: #243a6e;
    --pink: #ff6600; --pink-bright: #ff8533; --pink-dim: rgba(255,102,0,0.10); --pink-glow: rgba(255,102,0,0.25);
    --blue-accent: #0066cc; --blue-bright: #0080ff; --blue-dim: rgba(0,102,204,0.12);
    --bg: var(--navy-deep); --text: #e8eaf0; --text-secondary: #a0aec0; --hint: #6878a0;
    --card-bg: #101d38; --surface: #162040; --border: rgba(255,255,255,0.06); --border-accent: rgba(255,126,179,0.15);
    --success: #34d399; --danger: #f56565; --radius: 14px; --radius-sm: 10px;
  }
  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  body { font-family:'Outfit',-apple-system,BlinkMacSystemFont,sans-serif; background:var(--bg); color:var(--text); overflow-x:hidden; padding-bottom:110px; -webkit-font-smoothing:antialiased; min-height:100vh; }
  .age-gate { position:fixed;inset:0;z-index:9999;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:32px 24px;text-align:center; }
  .age-gate-brand { display:flex;align-items:center;gap:10px;margin-bottom:6px; }
  .age-gate-shield { width:42px;height:42px;background:linear-gradient(135deg,var(--navy-mid),var(--pink));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px; }
  .age-gate-logo-text .name { font-size:22px;font-weight:800;color:#fff;line-height:1.1; }
  .age-gate-logo-text .name span { color:var(--pink); }
  .age-gate-logo-text .sub { font-size:9px;color:var(--hint);text-transform:uppercase;letter-spacing:3px;font-weight:600; }
  .age-gate-divider { width:40px;height:3px;border-radius:2px;background:linear-gradient(90deg,var(--navy-light),var(--pink));margin:20px 0; }
  .age-gate-icon { font-size:44px;margin-bottom:16px; }
  .age-gate-title { font-size:19px;font-weight:700;margin-bottom:6px; }
  .age-gate-text { font-size:13px;color:var(--hint);line-height:1.6;margin-bottom:24px;max-width:320px; }
  .age-gate-checks { display:flex;flex-direction:column;gap:12px;width:100%;max-width:340px;margin-bottom:24px; }
  .age-check { display:flex;align-items:flex-start;gap:10px;text-align:left;cursor:pointer;-webkit-user-select:none;user-select:none; }
  .check-box { width:22px;height:22px;border-radius:6px;border:2px solid rgba(255,255,255,.12);background:var(--surface);flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all .2s ease;margin-top:1px; }
  .check-box.checked { background:var(--pink);border-color:var(--pink); }
  .check-box::after { content:'checkmark';color:transparent;font-size:0; }
  .check-box.checked::after { content:'‚úì';color:#fff;font-size:13px;font-weight:700; }
  .check-label { font-size:13px;color:var(--text-secondary);line-height:1.4; }
  .check-label strong { color:#fff; }
  .age-enter-btn { width:100%;max-width:340px;padding:14px;border:none;border-radius:var(--radius-sm);background:linear-gradient(135deg,var(--pink),var(--pink-bright));color:#fff;font-size:15px;font-weight:700;font-family:inherit;cursor:pointer;opacity:.3;pointer-events:none; }
  .age-enter-btn.enabled { opacity:1;pointer-events:auto; }
  .banner { position:relative;width:100%;padding:24px 18px 22px;background:linear-gradient(170deg,#0d1a33,#112244 40%,#0f1d3a 70%,#14203a);overflow:hidden; }
  .banner-glow-o { position:absolute;top:-60%;right:-30%;width:280px;height:280px;border-radius:50%;background:radial-gradient(circle,rgba(255,126,179,.07),transparent 65%);pointer-events:none; }
  .banner-glow-b { position:absolute;bottom:-40%;left:-20%;width:220px;height:220px;border-radius:50%;background:radial-gradient(circle,rgba(46,123,196,.06),transparent 65%);pointer-events:none; }
  .banner-top { display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;position:relative;z-index:1; }
  .brand-row { display:flex;align-items:center;gap:10px; }
  .brand-shield { width:38px;height:38px;background:linear-gradient(135deg,var(--navy-mid),var(--pink));border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0; }
  .brand-text .b-name { font-size:18px;font-weight:800;color:#fff;line-height:1.1; }
  .brand-text .b-name span { color:var(--pink); }
  .brand-text .b-tag { font-size:8.5px;color:var(--hint);text-transform:uppercase;letter-spacing:2.5px;font-weight:600;margin-top:1px; }
  .live-badge { display:flex;align-items:center;gap:5px;background:var(--pink-dim);border:1px solid var(--border-accent);padding:5px 10px;border-radius:8px;font-size:11px;font-weight:600;color:var(--pink); }
  .pulse-dot { width:6px;height:6px;border-radius:50%;background:var(--pink);animation:pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.5} }
  .banner-stats { display:flex;gap:7px;position:relative;z-index:1; }
  .stat-chip { flex:1;background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 8px;text-align:center; }
  .stat-value { font-family:'JetBrains Mono',monospace;font-size:15px;font-weight:700; }
  .stat-value.pink { color:var(--pink); }
  .stat-value.blue { color:var(--blue-bright); }
  .stat-label { font-size:9px;color:var(--hint);text-transform:uppercase;letter-spacing:1.2px;margin-top:2px;font-weight:500; }
  .nav-tabs { display:flex;gap:4px;padding:10px 12px 6px;background:var(--bg);position:sticky;top:0;z-index:100;border-bottom:1px solid var(--border); }
  .nav-tab { flex:1;padding:10px 8px;text-align:center;font-size:12px;font-weight:600;color:var(--hint);background:none;border:none;border-radius:var(--radius-sm);cursor:pointer;font-family:inherit;transition:all .2s ease;position:relative; }
  .nav-tab.active { color:var(--pink);background:var(--pink-dim); }
  .nav-tab.active::after { content:'';position:absolute;bottom:-7px;left:50%;transform:translateX(-50%);width:20px;height:2px;background:var(--pink);border-radius:1px; }
  .categories { display:flex;gap:8px;padding:12px 16px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none; }
  .categories::-webkit-scrollbar { display:none; }
  .cat-pill { flex-shrink:0;padding:7px 14px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;transition:all .2s ease;border:1px solid var(--border);background:transparent;color:var(--hint);font-family:inherit; }
  .cat-pill.active { background:linear-gradient(135deg,var(--pink),var(--pink-bright));color:#fff;border-color:var(--pink); }
  .section-header { display:flex;align-items:center;justify-content:space-between;padding:12px 16px 8px; }
  .section-title { font-size:17px;font-weight:700; }
  .section-count { font-size:11px;color:var(--hint);font-family:'JetBrains Mono',monospace; }
  .products-grid { display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:4px 12px 16px; }
  .product-card { background:var(--card-bg);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;transition:transform .15s ease;position:relative;animation:fadeInUp .35s ease backwards; }
  .product-card:active { transform:scale(.97); }
  .product-card:nth-child(1){animation-delay:0s} .product-card:nth-child(2){animation-delay:.04s} .product-card:nth-child(3){animation-delay:.08s} .product-card:nth-child(4){animation-delay:.12s}
  @keyframes fadeInUp { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }
  .product-visual { position:relative;width:100%;aspect-ratio:1;display:flex;align-items:center;justify-content:center;flex-direction:column;overflow:hidden;background: #fff; }
  .product-img { width:100%;height:100%;object-fit:contain;z-index:1; }
  .product-icon { font-size:42px;z-index:1; }
  .product-form-tag { position:absolute;bottom:6px;left:8px;font-size:8.5px;font-family:'JetBrains Mono',monospace;color:var(--blue-bright);background:var(--blue-dim);padding:2px 8px;border-radius:4px;z-index:2; }
  .product-badge { position:absolute;top:8px;left:8px;font-size:8.5px;font-weight:700;padding:3px 7px;border-radius:6px;text-transform:uppercase;z-index:2; }
  .badge-new { background:var(--blue-accent);color:#fff; }
  .badge-hot { background:var(--pink);color:#fff; }
  .product-info { padding:10px 12px 12px; }
  .product-name { font-size:13px;font-weight:700;line-height:1.3;margin-bottom:1px; }
  .product-conc { font-size:10px;font-family:'JetBrains Mono',monospace;color:var(--hint);margin-bottom:2px; }
  .product-purity { font-size:10px;color:var(--blue-bright);font-weight:600;margin-bottom:8px; }
  .product-bottom { display:flex;align-items:center;justify-content:space-between; }
  .product-price { font-family:'JetBrains Mono',monospace;font-size:16px;font-weight:700;color:var(--text); }
  .product-price .dollar { font-size:12px;color:var(--hint); }
  .add-btn { width:32px;height:32px;border-radius:8px;border:1.5px solid var(--pink);background:var(--pink-dim);color:var(--pink);font-size:18px;display:flex;align-items:center;justify-content:center;cursor:pointer; }
  .qty-control { display:flex;align-items:center;gap:2px;background:linear-gradient(135deg,var(--pink),var(--pink-bright));border-radius:8px;padding:2px; }
  .qty-btn { width:28px;height:28px;border-radius:6px;border:none;background:rgba(255,255,255,.15);color:#fff;font-size:15px;font-weight:700;display:flex;align-items:center;justify-content:center;cursor:pointer; }
  .qty-value { min-width:20px;text-align:center;font-size:13px;font-weight:700;color:#fff;font-family:'JetBrains Mono',monospace; }
  .overlay { position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);z-index:1000;opacity:0;pointer-events:none;transition:opacity .3s ease; }
  .overlay.visible { opacity:1;pointer-events:auto; }
  .sheet { position:fixed;bottom:0;left:0;right:0;background:var(--bg);border-radius:24px 24px 0 0;z-index:1001;transform:translateY(100%);transition:transform .35s cubic-bezier(.2,1,.2,1);max-height:90vh;display:flex;flex-direction:column; }
  .sheet.visible { transform:translateY(0); }
  .sheet-header { padding:20px 20px 12px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border); }
  .sheet-title { font-size:18px;font-weight:800; }
  .sheet-close { font-size:13px;font-weight:600;color:var(--hint);cursor:pointer; }
  .sheet-content { padding:16px 20px 24px;overflow-y:auto;flex:1; }
  .cart-item { display:flex;align-items:center;gap:12px;margin-bottom:16px; }
  .cart-item-info { flex:1; }
  .cart-item-name { font-size:14px;font-weight:700; }
  .cart-item-price { font-size:12px;color:var(--hint);font-family:'JetBrains Mono',monospace; }
  .cart-summary { margin-top:20px;padding-top:16px;border-top:1px solid var(--border); }
  .summary-row { display:flex;justify-content:space-between;margin-bottom:8px;font-size:14px; }
  .summary-total { font-size:18px;font-weight:800;margin-top:12px;padding-top:12px;border-top:1px solid var(--border); }
  .checkout-btn { width:100%;padding:16px;border:none;border-radius:14px;background:linear-gradient(135deg,var(--pink),var(--pink-bright));color:#fff;font-size:16px;font-weight:700;font-family:inherit;cursor:pointer;margin-top:20px;box-shadow:0 4px 20px var(--pink-glow); }
  .checkout-btn:disabled { opacity:.5;cursor:not-allowed; }
  .toast { position:fixed;bottom:120px;left:50%;transform:translateX(-50%) translateY(20px);background:rgba(20,30,50,.95);color:#fff;padding:12px 20px;border-radius:12px;font-size:13px;font-weight:600;z-index:9999;opacity:0;transition:all .3s ease;pointer-events:none;border:1px solid var(--border-accent);box-shadow:0 8px 24px rgba(0,0,0,.3);text-align:center;min-width:200px; }
  .toast.show { opacity:1;transform:translateX(-50%) translateY(0); }
  .chat-badge { position:fixed;bottom:110px;right:20px;width:56px;height:56px;background:linear-gradient(135deg,var(--blue-accent),var(--blue-bright));border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;box-shadow:0 4px 16px rgba(46,123,196,.3);cursor:pointer;z-index:900;transition:all .3s ease; }
  .chat-badge:active { transform:scale(.9); }
  .chat-badge.show::after { content:'';position:absolute;top:0;right:0;width:14px;height:14px;background:var(--pink);border:2px solid var(--bg);border-radius:50%; }
  .chat-panel { position:fixed;inset:0;background:var(--bg);z-index:2000;display:flex;flex-direction:column;transform:translateY(100%);transition:transform .4s cubic-bezier(.2,1,.2,1); }
  .chat-panel.open { transform:translateY(0); }
  .chat-header { padding:16px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);background:var(--card-bg); }
  .chat-messages { flex:1;padding:20px;overflow-y:auto;display:flex;flex-direction:column;gap:12px; }
  .chat-msg { max-width:85%;padding:12px 16px;border-radius:16px;font-size:14px;line-height:1.5; }
  .chat-msg.bot { align-self:flex-start;background:var(--surface);border-bottom-left-radius:4px; }
  .chat-msg.user { align-self:flex-end;background:var(--blue-accent);color:#fff;border-bottom-right-radius:4px; }
  .chat-input-area { padding:16px 20px;border-top:1px solid var(--border);display:flex;gap:10px;background:var(--card-bg); }
  .chat-input { flex:1;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px 16px;color:#fff;font-family:inherit;font-size:14px;outline:none; }
  .chat-send { width:44px;height:44px;border-radius:12px;background:var(--blue-accent);border:none;color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer; }
  .typing-dots { display:flex;gap:4px;padding:4px 0; }
  .typing-dots span { width:6px;height:6px;background:var(--hint);border-radius:50%;animation:typing 1.4s infinite; }
  .typing-dots span:nth-child(2){animation-delay:.2s} .typing-dots span:nth-child(3){animation-delay:.4s}
  @keyframes typing { 0%,100%{opacity:.3;transform:translateY(0)} 50%{opacity:1;transform:translateY(-4px)} }
</style>
</head>
<body>
<div id="app"></div>
<div id="toast" class="toast"></div>
<div class="chat-badge" onclick="toggleChat()">üí¨</div>
<div id="chatPanel" class="chat-panel">
  <div class="chat-header"><div style="font-weight:800">Research Assistant</div><div class="sheet-close" onclick="toggleChat()">Close</div></div>
  <div id="chatMessages" class="chat-messages"><div class="chat-msg bot">Hello! I'm your Rapid Research assistant. How can I help you today?</div></div>
  <div class="chat-input-area"><input type="text" id="chatInput" class="chat-input" placeholder="Ask a question..." onkeydown="handleChatKey(event)"><button id="chatSendBtn" class="chat-send" onclick="sendChatMessage()">üöÄ</button></div>
</div>
<script>
// ‚îÄ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const API_BASE = '';
const SHOP={name:"Rapid Labs",tagline:"RESEARCH PRODUCTS",currency:"$",
categories:[{id:"all",name:"All"},{id:"glp",name:"GLP"},{id:"peptides",name:"Peptides"},{id:"support",name:"Support"}],
products:[
{id:1,cat:"glp",icon:"üíâ",name:"GLP-1S",conc:"5mg / vial",purity:"Research",form:"Vial",price:44.99,badge:"hot"},
{id:2,cat:"glp",icon:"üíâ",name:"GLP-1S",conc:"10mg / vial",purity:"Research",form:"Vial",price:69.99,badge:""},
{id:3,cat:"glp",icon:"üíâ",name:"GLP-1S",conc:"15mg / vial",purity:"Research",form:"Vial",price:79.99,badge:""},
{id:4,cat:"glp",icon:"üíâ",name:"GLP-TR",conc:"5mg / vial",purity:"Research",form:"Vial",price:54.99,badge:""},
{id:5,cat:"glp",icon:"üíâ",name:"GLP-2R",conc:"10mg / vial",purity:"Research",form:"Vial",price:74.99,badge:""},
{id:6,cat:"glp",icon:"üíâ",name:"GLP-2R",conc:"15mg / vial",purity:"Research",form:"Vial",price:109.99,badge:""},
{id:7,cat:"glp",icon:"üíâ",name:"GLP-3R",conc:"5mg / vial",purity:"Research",form:"Vial",price:79.99,badge:""},
{id:8,cat:"glp",icon:"üíâ",name:"GLP-3R",conc:"10mg / vial",purity:"Research",form:"Vial",price:84.99,badge:""},
{id:9,cat:"glp",icon:"üíâ",name:"GLP-3R",conc:"15mg / vial",purity:"Research",form:"Vial",price:109.99,badge:""},
{id:10,cat:"peptides",icon:"üß¨",name:"GHK-Cu",conc:"50mg / vial",purity:"Research",form:"Vial",price:39.99,badge:""},
{id:11,cat:"peptides",icon:"üß¨",name:"GHK-Cu",conc:"100mg / vial",purity:"Research",form:"Vial",price:59.99,badge:""},
{id:12,cat:"peptides",icon:"üß¨",name:"MOTS-C",conc:"10mg / vial",purity:"Research",form:"Vial",price:34.99,badge:""},
{id:13,cat:"peptides",icon:"üß¨",name:"Selank",conc:"10mg / vial",purity:"Research",form:"Vial",price:29.99,badge:""},
{id:14,cat:"peptides",icon:"üß¨",name:"5-Amino-1MQ",conc:"10mg / vial",purity:"Research",form:"Vial",price:49.99,badge:"new"},
{id:15,cat:"support",icon:"üíß",name:"Bacteriostatic Water",conc:"10ml / vial",purity:"Sterile",form:"Liquid",price:25.00,badge:"",image:"images/bac-water.png"},
{id:16,cat:"support",icon:"‚ö°",name:"NAD+",conc:"500mg / vial",purity:"Research",form:"Vial",price:69.99,badge:""},
]};
const tg=window.Telegram?.WebApp;
let S={ageVerified:false,ageChecks:[false,false,false],page:'shop',category:'all',cart:{},cartSheetOpen:false,orders:[],shipping:{name:'',email:'',address:'',city:'',state:'',zip:'',country:'US'},promoCode:'',promoInput:'',promoStatus:''};
function haptic(t){try{if(t==='light')tg?.HapticFeedback?.impactOccurred('light');else if(t==='medium')tg?.HapticFeedback?.impactOccurred('medium');else if(t==='success')tg?.HapticFeedback?.notificationOccurred('success');else if(t==='sel')tg?.HapticFeedback?.selectionChanged();}catch(e){}}
function cartTotal(){let t=0;for(const[id,qty]of Object.entries(S.cart)){const p=SHOP.products.find(x=>x.id===+id);if(p)t+=p.price*qty;}return t;}
function cartCount(){return Object.values(S.cart).reduce((s,q)=>s+q,0);}
function addToCart(id){S.cart[id]=(S.cart[id]||0)+1;haptic('light');render();}
function removeFromCart(id){if(S.cart[id]){S.cart[id]--;if(S.cart[id]<=0)delete S.cart[id];}haptic('sel');render();}
function clearCart(){S.cart={};haptic('medium');closeSheet();render();}
function setCategory(c){S.category=c;haptic('sel');render();}
function setPage(p){S.page=p;haptic('sel');render();window.scrollTo(0,0);}
function openSheet(){S.cartSheetOpen=true;render();requestAnimationFrame(()=>{document.querySelector('.overlay')?.classList.add('visible');document.querySelector('.sheet')?.classList.add('visible');});}
function closeSheet(){document.querySelector('.overlay')?.classList.remove('visible');document.querySelector('.sheet')?.classList.remove('visible');setTimeout(()=>{S.cartSheetOpen=false;render();},350);}
function toggleAgeCheck(i){S.ageChecks[i]=!S.ageChecks[i];haptic('sel');render();}
function enterShop(){if(S.ageChecks.every(Boolean)){S.ageVerified=true;haptic('success');render();}}
function showToast(msg,duration=3000){const t=document.getElementById('toast');if(!t)return;t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),duration);}
const PROMO_CODES = {
  'FREESHIP': { freeShipping: true, label: 'Free shipping applied!' },
  'RAPIDSHIP': { freeShipping: true, label: 'Free shipping applied!' },
};
function updateShipping(field, value){ S.shipping[field]=value; }
function applyPromo(){
  const code = S.promoInput.trim().toUpperCase();
  if(!code){ S.promoStatus='empty'; render(); return; }
  if(PROMO_CODES[code]){
    S.promoCode=code;
    S.promoStatus='valid';
  } else {
    S.promoCode='';
    S.promoStatus='invalid';
  }
  render();
}
function removePromo(){ S.promoCode=''; S.promoInput=''; S.promoStatus=''; render(); }
function shippingValid(){ const s=S.shipping; return s.name&&s.email&&s.address&&s.city&&s.state&&s.zip; }
async function placeOrder(){
  const items=[];
  for(const[id,qty]of Object.entries(S.cart)){const p=SHOP.products.find(x=>x.id===+id);if(p)items.push({id:p.id,name:p.name,conc:p.conc,price:p.price,qty});}
  if(!items.length)return;
  const btn=document.querySelector('.checkout-btn');
  if(btn){btn.disabled=true;btn.textContent='Processing...';}
  try{
    const res=await fetch(`${API_BASE}/api/checkout`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({items,customerName:S.shipping.name||tg?.initDataUnsafe?.user?.first_name||'Customer',customerEmail:S.shipping.email,shippingAddress:S.shipping,promoCode:S.promoCode||null,origin:window.location.origin})});
    if(!res.ok){const err=await res.json().catch(()=>({}));throw new Error(err.error||'Checkout failed');}
    const data=await res.json();
    if(data.url){haptic('success');closeSheet();showToast('Redirecting to secure checkout...');setTimeout(()=>window.open(data.url,'_blank'),500);}
  }catch(err){showToast('Checkout unavailable. Please try again.');if(btn){btn.disabled=false;btn.textContent='Place Order';}}
}
function checkPaymentReturn(){
  const params=new URLSearchParams(window.location.search);
  if(params.get('payment')==='success'){
    haptic('success');showToast('Payment confirmed! Your order is being processed.',5000);
    S.orders.unshift({id:'RL-'+Date.now().toString(36).toUpperCase(),items:[{name:'Order',conc:'',qty:1,price:0}],total:0,date:new Date().toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}),status:'processing',step:1});
    window.history.replaceState({},'',window.location.pathname);
    setTimeout(()=>{S.page='orders';render();},1000);
  }else if(params.get('payment')==='cancelled'){showToast('Order cancelled. Your cart is still saved.');window.history.replaceState({},'',window.location.pathname);}
}
let chatOpen=false,chatHistory=[],chatLoading=false;
function toggleChat(){chatOpen=!chatOpen;document.getElementById('chatPanel').classList.toggle('open',chatOpen);document.getElementById('chatBadge').classList.remove('show');if(chatOpen)document.getElementById('chatInput').focus();}
function handleChatKey(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendChatMessage();}}
function appendChatMsg(role,text){const msgs=document.getElementById('chatMessages');const div=document.createElement('div');div.className='chat-msg '+(role==='user'?'user':'bot');div.textContent=text;msgs.appendChild(div);msgs.scrollTop=msgs.scrollHeight;return div;}
function showTyping(){const msgs=document.getElementById('chatMessages');const div=document.createElement('div');div.className='chat-msg typing';div.id='typingIndicator';div.innerHTML='<div class="typing-dots"><span></span><span></span><span></span></div>';msgs.appendChild(div);msgs.scrollTop=msgs.scrollHeight;}
function hideTyping(){document.getElementById('typingIndicator')?.remove();}
async function sendChatMessage(){
  if(chatLoading)return;
  const input=document.getElementById('chatInput');const text=input.value.trim();if(!text)return;
  input.value='';document.getElementById('chatSendBtn').disabled=true;
  appendChatMsg('user',text);chatHistory.push({role:'user',content:text});
  chatLoading=true;showTyping();
  try{
    const res=await fetch(`${API_BASE}/api/chat`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages:chatHistory})});
    hideTyping();if(!res.ok)throw new Error('Chat unavailable');
    const reader=res.body.getReader();const decoder=new TextDecoder();let botMsg=appendChatMsg('bot','');let fullText='';
    while(true){const{done,value}=await reader.read();if(done)break;const chunk=decoder.decode(value,{stream:true});for(const line of chunk.split('\n')){if(line.startsWith('0:"')){try{const parsed=JSON.parse(line.slice(2));fullText+=parsed;botMsg.textContent=fullText;document.getElementById('chatMessages').scrollTop=document.getElementById('chatMessages').scrollHeight;}catch(e){}}}}
    if(fullText)chatHistory.push({role:'assistant',content:fullText});else botMsg.textContent="I'm here to help! Ask me about our research products.";
  }catch(err){hideTyping();appendChatMsg('bot',"Sorry, having trouble connecting. Please try again!");}
  chatLoading=false;document.getElementById('chatSendBtn').disabled=false;input.focus();
}
function render(){
  if(!S.ageVerified){
    document.getElementById('app').innerHTML=`<div class="age-gate">
      <div class="age-gate-brand"><div class="age-gate-shield">&#x1F9EA;</div><div class="age-gate-logo-text"><div class="name">Rapid <span>Research</span></div><div class="sub">Research Products</div></div></div>
      <div class="age-gate-divider"></div>
      <div class="age-gate-icon">&#x1F52C;</div>
      <div class="age-gate-title">Welcome to Rapid Research</div>
      <div class="age-gate-text">Premium peptide research supplies. Please confirm the following to continue.</div>
      <div class="age-gate-checks">
        <div class="age-check" onclick="toggleAgeCheck(0)"><div class="check-box ${S.ageChecks[0]?'checked':''}"></div><span class="check-label">I am at least <strong>18 years of age</strong></span></div>
        <div class="age-check" onclick="toggleAgeCheck(1)"><div class="check-box ${S.ageChecks[1]?'checked':''}"></div><span class="check-label">I agree to the <strong>Terms &amp; Conditions</strong> of Rapid Research Co.</span></div>
        <div class="age-check" onclick="toggleAgeCheck(2)"><div class="check-box ${S.ageChecks[2]?'checked':''}"></div><span class="check-label">These products are for <strong>laboratory research use only</strong> and not for human consumption.</span></div>
      </div>
      <button class="age-enter-btn ${S.ageChecks.every(Boolean)?'enabled':''}" onclick="enterShop()">Enter Store</button>
    </div>`;
    return;
  }
  const count=cartCount(),total=cartTotal();
  const prods=S.category==='all'?SHOP.products:SHOP.products.filter(p=>p.cat===S.category);
  const ac=SHOP.categories.find(c=>c.id===S.category);
  let page='';
  if(S.page==='shop'){
    const cards=prods.map(p=>{
      const qty=S.cart[p.id]||0;
      const bc=p.badge==='new'?'badge-new':p.badge==='hot'?'badge-hot':'';
      const bl=p.badge==='new'?'NEW':p.badge==='hot'?'POPULAR':'';
      const badge=bl?`<div class="product-badge ${bc}">${bl}</div>`:'';
      const ctrl=qty>0
        ?`<div class="qty-control"><button class="qty-btn" onclick="event.stopPropagation();removeFromCart(${p.id})">&#x2212;</button><span class="qty-value">${qty}</span><button class="qty-btn" onclick="event.stopPropagation();addToCart(${p.id})">+</button></div>`
        :`<button class="add-btn" onclick="event.stopPropagation();addToCart(${p.id})">+</button>`;
      return`<div class="product-card"><div class="product-visual">${badge}${p.image?(`<img class="product-img" src="`+p.image+`" alt="`+p.name+`" loading="lazy">`):'<span class="product-icon">'+p.icon+'</span>'}<span class="product-form-tag">${p.form}</span></div><div class="product-info"><div class="product-name">${p.name}</div><div class="product-conc">${p.conc}</div><div class="product-purity">Quality: ${p.purity}</div><div class="product-bottom"><div class="product-price"><span class="dollar">$</span>${p.price.toFixed(2)}</div>${ctrl}</div></div></div>`;
    }).join('');
    page=`<div class="banner"><div class="banner-glow-o"></div><div class="banner-glow-b"></div>
    <div class="banner-top"><div class="brand-row"><div class="brand-shield">&#x1F9EA;</div><div class="brand-text"><div class="b-name">Rapid <span>Research</span></div><div class="b-tag">${SHOP.tagline}</div></div></div><div class="live-badge"><div class="pulse-dot"></div>In Stock</div></div>
    <div class="banner-stats"><div class="stat-chip"><div class="stat-value pink">Pure</div><div class="stat-label">Quality</div></div><div class="stat-chip"><div class="stat-value blue">Fast</div><div class="stat-label">Shipping</div></div><div class="stat-chip"><div class="stat-value pink">Eco</div><div class="stat-label">Friendly</div></div></div></div>
    <div class="categories">${SHOP.categories.map(c=>`<button class="cat-pill ${c.id===S.category?'active':''}" onclick="setCategory('${c.id}')">${c.name}</button>`).join('')}</div>
    <div class="section-header"><div class="section-title">${ac?.name||'All'}</div><div class="section-count">${prods.length} item${prods.length!==1?'s':''}</div></div>
    <div class="products-grid">${cards}</div>`;
  }else if(S.page==='orders'){
    if(!S.orders.length)page=`<div class="orders-page"><div class="empty-orders"><div class="empty-orders-icon">üì¶</div><div class="empty-orders-title">No Orders Yet</div><div class="empty-orders-text">Your order history will appear here</div></div></div>`;
    else page=`<div class="orders-page">${S.orders.map(o=>{const sc=o.status==='processing'?'status-processing':o.status==='shipped'?'status-shipped':'status-delivered';const sl=o.status==='processing'?'‚è≥ Processing':o.status==='shipped'?'üöö Shipped':'‚úÖ Delivered';const fp=o.step===1?0:o.step===2?33:o.step===3?66:100;return`<div class="order-card"><div class="order-header"><div class="order-id">${o.id}</div><div class="order-date">${o.date}</div></div><div class="order-status ${sc}">${sl}</div><div class="tracking-steps"><div class="tracking-line"><div class="tracking-line-fill" style="width:${fp}%"></div></div>${['Confirmed','Shipped','In Transit','Delivered'].map((l,i)=>`<div class="tracking-step"><div class="step-dot ${o.step>=i+1?'done':''}"></div><div class="step-label ${o.step===i+1?'active':''}">${l}</div></div>`).join('')}</div><div class="order-items">${o.items.map(i=>`${i.name}${i.conc?' ('+i.conc+')':''} √ó ${i.qty}`).join('<br>')}</div><div class="order-total">${o.total>0?'$'+o.total.toFixed(2):'Paid via Stripe'}</div></div>`;}).join('')}</div>`;
  }
  const nav=`<div class="nav-tabs"><button class="nav-tab ${S.page==='shop'?'active':''}" onclick="setPage('shop')">Shop</button><button class="nav-tab ${S.page==='orders'?'active':''}" onclick="setPage('orders')">Orders</button></div>`;
  const cartBtn=count>0?`<div style="position:fixed;bottom:20px;left:20px;right:20px;z-index:900;"><button class="checkout-btn" onclick="openSheet()" style="margin:0;display:flex;justify-content:space-between;align-items:center;"><span>View Cart (${count})</span><span>$${total.toFixed(2)}</span></button></div>`:'';
  const shippingFee=total>=150?0:9.95;
  const cartItems=Object.entries(S.cart).map(([id,qty])=>{const p=SHOP.products.find(x=>x.id===+id);return p?`<div class="cart-item"><div class="cart-item-info"><div class="cart-item-name">${p.name}</div><div class="cart-item-price">${qty} √ó $${p.price.toFixed(2)}</div></div><div class="qty-control"><button class="qty-btn" onclick="removeFromCart(${p.id})">&#x2212;</button><span class="qty-value">${qty}</span><button class="qty-btn" onclick="addToCart(${p.id})">+</button></div></div>`:'';}).join('');
  const sheet=`<div class="overlay" onclick="closeSheet()"></div><div class="sheet"><div class="sheet-header"><div class="sheet-title">Your Order</div><div class="sheet-close" onclick="closeSheet()">Close</div></div><div class="sheet-content">${cartItems}<div class="cart-summary"><div class="summary-row"><span>Subtotal</span><span>$${total.toFixed(2)}</span></div><div class="summary-row"><span>Shipping</span><span>${shippingFee===0?'FREE':'$'+shippingFee.toFixed(2)}</span></div>${total<150?`<div style="font-size:11px;color:var(--pink);margin-top:4px;">Add $${(150-total).toFixed(2)} more for free shipping</div>`:''}<div class="summary-total summary-row"><span>Total</span><span>$${(total+shippingFee).toFixed(2)}</span></div><div style="margin-top:20px;padding:12px;background:rgba(255,102,0,0.05);border:1px solid var(--pink-dim);border-radius:10px;font-size:11px;color:var(--pink);display:flex;gap:8px;align-items:center;"><span>&#x26A0;</span><span><strong>RESEARCH USE ONLY</strong> ‚Äî All products for laboratory research exclusively. Not for human consumption.</span></div><button class="checkout-btn" onclick="placeOrder()">Place Order ‚Äî $${(total+shippingFee).toFixed(2)}</button></div></div></div>`;
  document.getElementById('app').innerHTML=nav+page+cartBtn+sheet;
}
window.onload=()=>{checkPaymentReturn();render();};
</script>
</body>
</html>
